<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Signature Generator - Brand Central (Supabase)</title>
    <style>
        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(31, 22, 51, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 15px 0;
            transition: all 0.3s ease;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            color: #3FCBFF;
            text-decoration: none;
        }

        .logo img {
            height: 28px;
            margin-right: 8px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 25px;
            align-items: center;
        }

        .nav-links a {
            color: #FFFFFF;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
            font-size: 14px;
        }

        .nav-links a:hover {
            color: #3FCBFF;
        }

        .back-btn {
            background: linear-gradient(45deg, #3FCBFF, #2db8e8);
            color: #1F1633 !important;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .back-btn:hover {
            color: #1F1633 !important;
            transform: translateY(-2px);
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: #1F1633;
            color: #FFFFFF;
            padding: 80px 20px 20px;
            margin: 0;
            min-height: 100vh;
        }

        .center-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding-top: 40px;
        }

        .main-container {
            display: flex;
            gap: 40px;
            max-width: 1200px;
            width: 100%;
            align-items: flex-start;
        }

        .left-panel {
            flex: 0 0 400px;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-fields {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        input[type="text"], input[type="file"] {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
            padding: 12px;
            font-size: 14px;
            border: 1px solid rgba(63, 203, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: #222;
            font-family: 'Manrope', sans-serif;
        }

        input[type="text"]:focus, input[type="file"]:focus {
            outline: none;
            border-color: #3FCBFF;
            box-shadow: 0 0 0 2px rgba(63, 203, 255, 0.2);
        }

        label {
            margin-top: 5px;
            margin-bottom: 8px;
            font-weight: 600;
            text-align: left;
            font-size: 14px;
            color: #FFFFFF;
        }

        #preview {
            background: #FFFFFF;
            padding: 20px;
            border: 2px solid #3FCBFF;
            border-radius: 12px;
            width: 100%;
            box-sizing: border-box;
            min-height: 300px;
        }

        .preview-container {
            background: rgba(63, 203, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(63, 203, 255, 0.2);
        }

        .preview-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(63, 203, 255, 0.2);
        }

        .preview-header h2 {
            margin: 0;
            color: #3FCBFF;
            font-size: 1.5em;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        #copyBtn, #saveBtn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #3FCBFF, #2db8e8);
            color: #1F1633;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
        }

        #copyBtn {
            background: linear-gradient(45deg, #B8A9D9, #A593D1);
            color: #1F1633;
            padding: 10px 20px;
            font-size: 13px;
            border-radius: 6px;
        }

        #copyBtn:hover {
            background: linear-gradient(45deg, #A593D1, #9683C8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(184, 169, 217, 0.4);
        }

        #copyBtn:hover, #saveBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(63, 203, 255, 0.3);
        }

        #copyMsg, #saveMsg {
            margin-left: 10px;
            color: #3FCBFF;
            font-size: 14px;
            display: none;
        }

        #headshot-controls {
            margin-bottom: 20px;
            background: rgba(63, 203, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(63, 203, 255, 0.2);
            width: 100%;
            box-sizing: border-box;
        }

        .form-section {
            background: rgba(63, 203, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(63, 203, 255, 0.2);
            margin-bottom: 20px;
        }

        .form-section h3 {
            margin: 0 0 15px 0;
            color: #3FCBFF;
            font-size: 1.2em;
            font-weight: 600;
        }

        #headshot-preview-container {
            width: 70px;
            height: 70px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            background: #eee;
            border-radius: 16px 0px 16px 0px;
            margin-right: 10px;
        }

        #headshot-preview {
            position: relative;
            width: 100%;
            height: 100%;
            user-select: none;
            pointer-events: none;
        }

        .slider-label {
            font-size: 13px;
            margin-right: 6px;
        }

        .slider {
            width: 120px;
            vertical-align: middle;
        }

        #savedSignatures {
            width: 100%;
            margin-top: 30px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                gap: 30px;
            }
            
            .left-panel {
                flex: none;
                width: 100%;
                max-width: 500px;
                margin: 0 auto;
            }
            
            .right-panel {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                gap: 20px;
                padding: 0 10px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            #copyBtn, #saveBtn {
                width: 100%;
            }
        }

        .collapsible-header {
            background: #3FCBFF;
            color: #1F1633;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .collapsible-header:hover {
            background: #2db8e8;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(63, 203, 255, 0.1);
            border-radius: 0 0 8px 8px;
        }

        .collapsible-content.active {
            max-height: 800px;
            padding: 20px;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
        }

        .collapse-icon.rotated {
            transform: rotate(180deg);
        }

        .signature-card {
            background: #fff;
            color: #222;
            padding: 16px;
            margin-bottom: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(31,22,51,0.08);
        }

            .signature-card img {
                width: 50px;
                height: 50px;
                border-radius: 8px;
                margin-top: 8px;
                object-fit: cover;
            }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="assets/logos/icon-only.svg" alt="Paradigm Logo">
                Brand Central
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="guidelines.html">Guidelines</a></li>
                <li><a href="assets.html">Assets</a></li>
                <li><a href="resources.html" style="color: #3FCBFF;">Tools</a></li>
                <li><a href="boost.html">Boost</a></li>

                <li id="auth-user-info" style="display: none;"></li>
                <li><a href="index.html" class="back-btn">← Back to Home</a></li>
                <li><a href="login.html" id="auth-login-btn" style="display: none;">Sign In</a></li>
            </ul>
        </div>
    </nav>
    <div class="center-ui">
        <h1 style="text-align: center; margin-bottom: 40px; color: #3FCBFF;">Email Signature Generator</h1>
        
        <div class="main-container">
            <!-- Left Panel - Form Fields -->
            <div class="left-panel">
                <div class="form-section">
                    <h3>Personal Information</h3>
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" placeholder="Your Name" oninput="generateSignature()">
                    
                    <label for="title">Job Title</label>
                    <input type="text" id="title" placeholder="Your Title" oninput="generateSignature()">
                    
                    <label for="phone">Cell Phone</label>
                    <input type="text" id="phone" placeholder="(555) 123-4567" oninput="generateSignature()">
                    
                    <label for="emailUser">Email Username</label>
                    <input type="text" id="emailUser" placeholder="john" oninput="generateSignature()">
                    <small style="color: rgba(255,255,255,0.7); font-size: 12px;">@paradigmproductionsgroup.com will be added automatically</small>
                </div>

                <div class="form-section">
                    <h3>Profile Photo</h3>
                    <label for="headshot">Upload Headshot</label>
                    <input type="file" id="headshot" accept="image/*">
                    
                    <div id="headshot-controls" style="display:none;">
                        <div style="margin-bottom: 10px;">
                            <span class="slider-label">Zoom:</span>
                            <input type="range" id="zoomSlider" class="slider" min="1" max="3" step="0.001" value="1">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span class="slider-label">Pan X:</span>
                            <input type="range" id="panXSlider" class="slider" min="-35" max="35" step="1" value="0">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <span class="slider-label">Pan Y:</span>
                            <input type="range" id="panYSlider" class="slider" min="-35" max="35" step="1" value="0">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div id="headshot-preview-container">
                                <canvas id="headshot-preview" width="70" height="70"></canvas>
                            </div>
                            <button type="button" onclick="applyHeadshot()" style="padding: 8px 16px; background: #3FCBFF; color: #1F1633; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Apply Headshot</button>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="saveBtn">Save Signature</button>
                </div>
                <div style="margin-top: 10px;">
                    <span id="saveMsg" style="color: #3FCBFF; font-size: 14px; display: none;">Saved!</span>
                </div>
            </div>

            <!-- Right Panel - Preview -->
            <div class="right-panel">
                <div class="preview-container">
                    <div class="preview-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="margin: 0;">Live Preview</h2>
                            <button id="copyBtn" onclick="copySignature()" style="display:none;">📋 Copy to Clipboard</button>
                        </div>
                        <p style="margin: 5px 0 0 0; color: rgba(255,255,255,0.8); font-size: 14px;">This is how your signature will appear in emails</p>
                        <div style="margin-top: 8px;">
                            <span id="copyMsg" style="color: #B8A9D9; font-size: 13px; display: none; font-weight: 500;">✅ Copied to clipboard!</span>
                        </div>
                    </div>
                    <div id="preview"></div>
                </div>
                
                <!-- Saved Signatures Section -->
                <div id="savedSignatures">
                    <button class="collapsible-header" onclick="toggleSavedSignatures()">
                        <span>Saved Signatures</span>
                        <span class="collapse-icon">▼</span>
                    </button>
                    <div class="collapsible-content" id="savedSignaturesContent">
                        <!-- Saved signatures will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden canvas for name/title/company box rendering -->
        <canvas id="nameTitleCanvas" width="220" height="70" style="display:none;"></canvas>
    </div>
    <script>
        let headshotImage = null;
        let headshotDataUrl = "";
        let tempHeadshotDataUrl = "";
        let zoom = 1, panX = 0, panY = 0;

        // Make headshotDataUrl globally accessible
        window.headshotDataUrl = "";

        document.getElementById("headshot").addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    tempHeadshotDataUrl = evt.target.result;
                    showHeadshotControls();
                };
                reader.readAsDataURL(file);
            } else {
                tempHeadshotDataUrl = "";
                headshotDataUrl = "";
                document.getElementById("headshot-controls").style.display = "none";
                generateSignature();
            }
        });

        function showHeadshotControls() {
            document.getElementById("headshot-controls").style.display = "block";
            panX = 0; panY = 0;
            document.getElementById("panXSlider").value = 0;
            document.getElementById("panYSlider").value = 0;
            loadHeadshotImage(tempHeadshotDataUrl);
        }

        function loadHeadshotImage(src) {
            headshotImage = new window.Image();
            headshotImage.onload = function () {
                // Calculate minimum zoom to fit the image in 70x70
                const zoomX = 70 / headshotImage.width;
                const zoomY = 70 / headshotImage.height;
                const minZoom = Math.max(zoomX, zoomY); // fill the area
                zoom = minZoom;
                document.getElementById("zoomSlider").min = minZoom;
                document.getElementById("zoomSlider").max = Math.max(minZoom * 3, 3);
                document.getElementById("zoomSlider").step = 0.001;
                document.getElementById("zoomSlider").value = zoom;
                drawHeadshotPreview();
            };
            headshotImage.src = src;
        }

        function drawHeadshotPreview() {
            const canvas = document.getElementById("headshot-preview");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, 70, 70);

            if (!headshotImage) return;

            // Calculate scaled size
            const scaledW = headshotImage.width * zoom;
            const scaledH = headshotImage.height * zoom;
            const offsetX = (70 - scaledW) / 2 + panX;
            const offsetY = (70 - scaledH) / 2 + panY;

            // Draw with custom border radius (top-left and bottom-right rounded, top-right and bottom-left square)
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(16, 0);
            ctx.lineTo(70, 0); // top edge - straight to top right (no rounding)
            ctx.lineTo(70, 54); // right edge - down to start of bottom-right rounding
            ctx.quadraticCurveTo(70, 70, 54, 70); // bottom-right corner (rounded)
            ctx.lineTo(0, 70); // bottom edge - straight to bottom left (no rounding)
            ctx.lineTo(0, 16); // left edge - up to start of top-left rounding
            ctx.quadraticCurveTo(0, 0, 16, 0); // top-left corner (rounded)
            ctx.closePath();
            ctx.clip();

            ctx.drawImage(headshotImage, offsetX, offsetY, scaledW, scaledH);
            ctx.restore();
        }

        document.getElementById("zoomSlider").addEventListener("input", function (e) {
            zoom = parseFloat(e.target.value);
            drawHeadshotPreview();
        });
        document.getElementById("panXSlider").addEventListener("input", function (e) {
            panX = parseInt(e.target.value, 10);
            drawHeadshotPreview();
        });
        document.getElementById("panYSlider").addEventListener("input", function (e) {
            panY = parseInt(e.target.value, 10);
            drawHeadshotPreview();
        });

        function applyHeadshot() {
            // Render the cropped/panned/zoomed image to a new canvas and get data URL
            const canvas = document.createElement("canvas");
            canvas.width = 70;
            canvas.height = 70;
            const ctx = canvas.getContext("2d");

            // Draw with custom border radius (top-left and bottom-right rounded, top-right and bottom-left square)
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(16, 0);
            ctx.lineTo(70, 0); // top edge - straight to top right (no rounding)
            ctx.lineTo(70, 54); // right edge - down to start of bottom-right rounding
            ctx.quadraticCurveTo(70, 70, 54, 70); // bottom-right corner (rounded)
            ctx.lineTo(0, 70); // bottom edge - straight to bottom left (no rounding)
            ctx.lineTo(0, 16); // left edge - up to start of top-left rounding
            ctx.quadraticCurveTo(0, 0, 16, 0); // top-left corner (rounded)
            ctx.closePath();
            ctx.clip();

            const scaledW = headshotImage.width * zoom;
            const scaledH = headshotImage.height * zoom;
            const offsetX = (70 - scaledW) / 2 + panX;
            const offsetY = (70 - scaledH) / 2 + panY;
            ctx.drawImage(headshotImage, offsetX, offsetY, scaledW, scaledH);
            ctx.restore();

            headshotDataUrl = canvas.toDataURL("image/png");
            window.headshotDataUrl = headshotDataUrl; // Update global reference
            document.getElementById("headshot-controls").style.display = "none";
            generateSignature();
        }

        // Phone number formatter
        function formatPhoneNumber(phone) {
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.substr(0, 3)}) ${digits.substr(3, 3)} - ${digits.substr(6, 4)}`;
            }
            return phone;
        }

        // Render the name/title/company box as a PNG with top right and bottom left rounded corners
        function renderNameTitleBoxAsImage(name, title, callback) {
            const canvas = document.getElementById("nameTitleCanvas");
            const ctx = canvas.getContext("2d");

            // Calculate required width based on text content
            ctx.font = "bold 18px 'Manrope', Arial, sans-serif";
            const nameWidth = ctx.measureText(name).width;
            
            ctx.font = "14px 'Manrope', Arial, sans-serif";
            const titleWidth = ctx.measureText(title).width;
            
            ctx.font = "13px 'Manrope', Arial, sans-serif";
            const companyWidth = ctx.measureText("Paradigm Productions Group").width;
            
            // Find the widest text and add padding
            const maxTextWidth = Math.max(nameWidth, titleWidth, companyWidth);
            const requiredWidth = Math.max(220, maxTextWidth + 32); // 16px padding on each side, minimum 220px
            
            // Resize canvas to fit content
            canvas.width = requiredWidth;
            canvas.height = 70;

            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw rounded rectangle (top right and bottom left rounded)
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(0, 0); // top left
            ctx.lineTo(canvas.width - 16, 0); // top edge
            ctx.quadraticCurveTo(canvas.width, 0, canvas.width, 16); // top right corner (rounded)
            ctx.lineTo(canvas.width, canvas.height); // right edge
            ctx.lineTo(16, canvas.height); // bottom edge
            ctx.quadraticCurveTo(0, canvas.height, 0, canvas.height - 16); // bottom left corner (rounded)
            ctx.lineTo(0, 0); // left edge
            ctx.closePath();
            ctx.fillStyle = "#3F105E";
            ctx.fill();
            ctx.restore();

            // Draw text with perfectly symmetrical vertical spacing
            ctx.font = "bold 18px 'Manrope', Arial, sans-serif";
            ctx.fillStyle = "#fff";
            ctx.textBaseline = "top";
            ctx.fillText(name, 16, 14);

            ctx.font = "14px 'Manrope', Arial, sans-serif";
            ctx.fillText(title, 16, 35);

            ctx.font = "13px 'Manrope', Arial, sans-serif";
            ctx.fillText("Paradigm Productions Group", 16, 51);

            // Return PNG data URL and width
            callback(canvas.toDataURL("image/png"), requiredWidth);
        }

        function generateCombinedLogoImage(bannerWidth, callback) {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            
            // Set initial canvas dimensions - we'll resize if needed
            // Start with a reasonable size that can accommodate logo, tagline, and button
            canvas.width = Math.max(bannerWidth + 160, 500); // Extra space for logo, tagline, and button
            canvas.height = 65;
            
            // Clear canvas with white background
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Load the Paradigm logo
            const logoImg = new Image();
            logoImg.crossOrigin = "anonymous";
            logoImg.onload = function() {
                // First, measure the tagline width to size the logo accordingly
                ctx.fillStyle = "#444444";
                ctx.font = "italic 13px Arial, sans-serif";
                ctx.textAlign = "left";
                ctx.textBaseline = "top";
                const taglineText = "Boutique Service Built on Trust";
                const taglineWidth = ctx.measureText(taglineText).width;
                
                // Size the logo to match the tagline width
                const logoWidth = taglineWidth;
                const logoHeight = (logoImg.height / logoImg.width) * logoWidth;
                const logoY = 5;
                ctx.drawImage(logoImg, 0, logoY, logoWidth, logoHeight);
                
                // Draw the tagline
                const taglineY = logoY + logoHeight + 6;
                ctx.fillText(taglineText, 0, taglineY);
                
                // Calculate total height of logo + gap + tagline for button height
                const totalContentHeight = logoHeight + 6 + 15; // logo + gap + tagline height (approx 15px for 13px font)
                
                // Position button to align with the leading edge of the name/title/company section
                const headshotOffset = window.headshotDataUrl ? 76 : 0;
                const buttonWidth = 80;
                const buttonX = headshotOffset; // Align with left edge of name/title banner
                const buttonY = logoY; // Start at same Y as logo
                const buttonHeight = totalContentHeight;
                const cornerRadius = 8;
                
                // Ensure canvas is wide enough for the button
                if (buttonX + buttonWidth > canvas.width) {
                    const newWidth = buttonX + buttonWidth + 10; // Add 10px padding
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    canvas.width = newWidth;
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Redraw logo and tagline
                    ctx.drawImage(logoImg, 0, logoY, logoWidth, logoHeight);
                    ctx.fillStyle = "#444444";
                    ctx.font = "italic 13px Arial, sans-serif";
                    ctx.textAlign = "left";
                    ctx.textBaseline = "top";
                    ctx.fillText(taglineText, 0, taglineY);
                }
                
                // Draw rounded rectangle for button (top-left and bottom-right corners only)
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(buttonX + cornerRadius, buttonY); // start at top-left rounded corner
                ctx.lineTo(buttonX + buttonWidth, buttonY); // top edge (no rounding on top-right)
                ctx.lineTo(buttonX + buttonWidth, buttonY + buttonHeight - cornerRadius); // right edge
                ctx.quadraticCurveTo(buttonX + buttonWidth, buttonY + buttonHeight, buttonX + buttonWidth - cornerRadius, buttonY + buttonHeight); // bottom-right corner (rounded)
                ctx.lineTo(buttonX, buttonY + buttonHeight); // bottom edge (no rounding on bottom-left)
                ctx.lineTo(buttonX, buttonY + cornerRadius); // left edge
                ctx.quadraticCurveTo(buttonX, buttonY, buttonX + cornerRadius, buttonY); // top-left corner (rounded)
                ctx.closePath();
                
                // Fill button background (white)
                ctx.fillStyle = "#FFFFFF";
                ctx.fill();
                
                // Button border (deep magenta)
                ctx.strokeStyle = "#3F105E";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.restore();
                
                // Button text
                ctx.fillStyle = "#222222";
                ctx.font = "bold 8px Arial, sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                // Multi-line button text
                const lines = ["GET STARTED", "WITH", "PARADIGM"];
                const lineHeight = Math.max(8, buttonHeight / 5); // Adjust line height based on button height
                const startY = buttonY + buttonHeight/2 - (lines.length-1) * lineHeight/2;
                
                lines.forEach((line, index) => {
                    ctx.fillText(line, buttonX + buttonWidth/2, startY + index * lineHeight);
                });
                
                // Return the canvas as data URL
                callback(canvas.toDataURL("image/png"));
            };
            
            logoImg.onerror = function() {
                // If logo fails to load, create a simplified version
                ctx.fillStyle = "#444444";
                ctx.font = "bold 16px Arial, sans-serif";
                ctx.textAlign = "left";
                ctx.textBaseline = "top";
                
                // Measure tagline width first
                ctx.font = "italic 13px Arial, sans-serif";
                const taglineText = "Boutique Service Built on Trust";
                const taglineWidth = ctx.measureText(taglineText).width;
                
                // Draw PARADIGM text to match tagline width
                ctx.font = "bold 16px Arial, sans-serif";
                const paradigmText = "PARADIGM";
                const paradigmWidth = ctx.measureText(paradigmText).width;
                const scaleFactor = taglineWidth / paradigmWidth;
                const adjustedFontSize = Math.max(12, 16 * scaleFactor); // Minimum 12px font
                ctx.font = `bold ${adjustedFontSize}px Arial, sans-serif`;
                ctx.fillText(paradigmText, 0, 10);
                
                ctx.font = "italic 13px Arial, sans-serif";
                const taglineY = 40;
                ctx.fillText(taglineText, 0, taglineY);
                
                // Position button to align with the leading edge of the name/title/company section
                const headshotOffset = window.headshotDataUrl ? 76 : 0;
                const buttonWidth = 80;
                const buttonX = headshotOffset; // Align with left edge of name/title banner
                const buttonY = 10; // Start at same Y as PARADIGM text
                const buttonHeight = taglineY + 15 - buttonY; // Align button bottom with tagline bottom
                const cornerRadius = 8;
                
                // Ensure canvas is wide enough for the button
                if (buttonX + buttonWidth > canvas.width) {
                    const newWidth = buttonX + buttonWidth + 10; // Add 10px padding
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    canvas.width = newWidth;
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.putImageData(imageData, 0, 0);
                    
                    // Redraw text
                    ctx.fillStyle = "#444444";
                    ctx.font = `bold ${adjustedFontSize}px Arial, sans-serif`;
                    ctx.textAlign = "left";
                    ctx.textBaseline = "top";
                    ctx.fillText(paradigmText, 0, 10);
                    ctx.font = "italic 13px Arial, sans-serif";
                    ctx.fillText(taglineText, 0, taglineY);
                }
                
                // Draw rounded rectangle for button (top-left and bottom-right corners only)
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(buttonX + cornerRadius, buttonY); // start at top-left rounded corner
                ctx.lineTo(buttonX + buttonWidth, buttonY); // top edge (no rounding on top-right)
                ctx.lineTo(buttonX + buttonWidth, buttonY + buttonHeight - cornerRadius); // right edge
                ctx.quadraticCurveTo(buttonX + buttonWidth, buttonY + buttonHeight, buttonX + buttonWidth - cornerRadius, buttonY + buttonHeight); // bottom-right corner (rounded)
                ctx.lineTo(buttonX, buttonY + buttonHeight); // bottom edge (no rounding on bottom-left)
                ctx.lineTo(buttonX, buttonY + cornerRadius); // left edge
                ctx.quadraticCurveTo(buttonX, buttonY, buttonX + cornerRadius, buttonY); // top-left corner (rounded)
                ctx.closePath();
                
                // Fill button background (white)
                ctx.fillStyle = "#FFFFFF";
                ctx.fill();
                
                // Button border (deep magenta)
                ctx.strokeStyle = "#3F105E";
                ctx.lineWidth = 1;
                ctx.stroke();
                ctx.restore();
                
                ctx.fillStyle = "#222222";
                ctx.font = "bold 8px Arial, sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                const lines = ["GET STARTED", "WITH", "PARADIGM"];
                const lineHeight = Math.max(8, buttonHeight / 5); // Adjust line height based on button height
                const startY = buttonY + buttonHeight/2 - (lines.length-1) * lineHeight/2;
                
                lines.forEach((line, index) => {
                    ctx.fillText(line, buttonX + buttonWidth/2, startY + index * lineHeight);
                });
                
                callback(canvas.toDataURL("image/png"));
            };
            
            logoImg.src = "https://gijhfdjsmlgivjhvbtve.supabase.co/storage/v1/object/public/assets/brand-assets/1753197346051_5re6il8qkxx.png";
        }

        function generateSignature() {
            const name = document.getElementById("fullName").value;
            const title = document.getElementById("title").value;
            const phone = document.getElementById("phone").value;
            const emailUser = document.getElementById("emailUser").value;
            const domain = "@paradigmproductionsgroup.com";
            const emailFull = emailUser + domain;
            
            // Get the current headshot data URL
            const currentHeadshotDataUrl = window.headshotDataUrl || headshotDataUrl || "";

            renderNameTitleBoxAsImage(name, title, function (nameTitleBoxDataUrl, bannerWidth) {
                // Store banner width globally for copy function
                window.currentBannerWidth = bannerWidth;
                
                // Generate a visible placeholder for the combined logo
                generateCombinedLogoImage(bannerWidth, function(combinedLogoDataUrl) {
                    // Headshot + name/title/company in a styled box, side by side, bottom-aligned
                    let headshotNameTitle = `
                                            <table cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse; width:100%;">
                                                <tr>
                                                    <td style="vertical-align:bottom; padding-right:6px; width:${currentHeadshotDataUrl ? '76px' : '0px'};">
                                                        ${currentHeadshotDataUrl ? `<img src="${currentHeadshotDataUrl}" alt="Headshot" style="width:70px; height:70px; object-fit:cover; border-radius:16px 0px 16px 0px; display:block;">` : ""}
                                                    </td>
                                                    <td style="vertical-align:bottom;">
                                                        <img src="${nameTitleBoxDataUrl}" alt="Name and Title" style="width:${bannerWidth}px; height:70px; display:block;">
                                                    </td>
                                                </tr>
                                            </table>
                                        `;

                    // Phone numbers (show nothing if empty)
                    let phoneBlock = "";
                    if (phone) {
                        phoneBlock += `<div style="font-size:12px; color:#222; margin-bottom:4px;">Cell: ${formatPhoneNumber(phone)}</div>`;
                    }
                    // Always show office number
                    phoneBlock += `<div style="font-size:12px; color:#222; margin-bottom:4px;">Office: (407) 909 - 1338</div>`;

                    // Signature layout with generated combined logo
                    const signatureHTML = `
                                            <table cellpadding="0" cellspacing="0" border="0" style="font-family: 'Manrope', Arial, sans-serif; background: #FFFFFF; color: #222222; border-collapse:collapse; width: 100%; box-sizing: border-box;">
                                                <!-- Top row: Headshot and Name/Title Banner -->
                                                <tr>
                                                    <td style="vertical-align:bottom; padding: 20px; padding-bottom: 12px;">
                                                        ${headshotNameTitle}
                                                    </td>
                                                </tr>
                                                <!-- Contact info row -->
                                                <tr>
                                                    <td style="vertical-align:top; padding-left: 20px; padding-right: 20px; padding-bottom: 4px;">
                                                        ${phoneBlock}
                                                        <div style="font-size:12px; color:#222; margin-bottom:4px;">
                                                            <a href="mailto:${emailFull}" style="color:#1F1633; text-decoration:none;">${emailFull}</a>
                                                        </div>
                                                        <div style="font-size:12px; color:#222; margin-bottom:4px;">
                                                            <a href="https://paradigmproductionsgroup.com" style="color:#1F1633; text-decoration:none;">www.paradigmproductionsgroup.com</a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <!-- Address row -->
                                                <tr>
                                                    <td style="vertical-align:top; padding-left: 20px; padding-right: 20px; padding-bottom: 12px;">
                                                        <div style="font-size:12px; color:#222;">
                                                            215 E Main Street, Leesburg, Florida 34748
                                                        </div>
                                                    </td>
                                                </tr>
                                                <!-- Combined Logo/Tagline/Button PNG row -->
                                                <tr>
                                                    <td style="vertical-align:top; padding-left: 20px; padding-right: 20px; padding-bottom: 20px;">
                                                        <a href="https://www.paradigmproductionsgroup.com" target="_blank" style="text-decoration:none; border:none; outline:none;">
                                                            <img id="combinedLogoPlaceholder" alt="Paradigm Logo - Boutique Service Built on Trust - Get Started with Paradigm" style="display:block; border:0; outline:none; text-decoration:none;" src="${combinedLogoDataUrl}">
                                                        </a>
                                                    </td>
                                                </tr>
                                            </table>
                                        `;

                    document.getElementById("preview").innerHTML = signatureHTML;
                    document.getElementById("copyBtn").style.display = "inline-block";
                    document.getElementById("copyMsg").style.display = "none";
                });
            });
        }

        // Make generateSignature globally accessible
        window.generateSignature = generateSignature;

        // Add debugging to ensure the function is available
        console.log("✅ generateSignature function defined and attached to window");
        
        // Fallback function in case of issues
        if (!window.generateSignature) {
            console.warn("⚠️ generateSignature not found on window, creating fallback");
            window.generateSignature = function() {
                console.log("🔄 Fallback generateSignature called");
                // Try to call the function by name
                if (typeof generateSignature === 'function') {
                    return generateSignature();
                } else {
                    console.error("❌ generateSignature function not found anywhere");
                }
            };
        }

        window.onload = function() {
            console.log("🚀 Window loaded, calling generateSignature");
            generateSignature();
        };


        // Toggle saved signatures panel
        function toggleSavedSignatures() {
            const content = document.getElementById("savedSignaturesContent");
            const icon = document.querySelector(".collapse-icon");
            
            content.classList.toggle("active");
            icon.classList.toggle("rotated");
        }

        function copySignature() {
            const preview = document.getElementById("preview");
            if (!preview.innerHTML.trim()) return;

            // Generate the combined logo with current banner width
            const bannerWidth = window.currentBannerWidth || 220;
            generateCombinedLogoImage(bannerWidth, function(combinedLogoDataUrl) {
                // Create a temporary element to select and copy HTML
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = preview.innerHTML;
                
                // Replace the placeholder with the actual combined logo and ensure no borders
                const placeholderImg = tempDiv.querySelector("#combinedLogoPlaceholder");
                if (placeholderImg) {
                    placeholderImg.src = combinedLogoDataUrl;
                    placeholderImg.removeAttribute("id"); // Remove ID to avoid conflicts
                    placeholderImg.style.border = "0";
                    placeholderImg.style.outline = "none";
                    placeholderImg.style.textDecoration = "none";
                    placeholderImg.setAttribute("border", "0");
                }
                
                // Also ensure the link has no borders
                const linkElement = tempDiv.querySelector("a[href*='paradigmproductionsgroup.com']");
                if (linkElement) {
                    linkElement.style.border = "none";
                    linkElement.style.outline = "none";
                    linkElement.style.textDecoration = "none";
                }
                
                document.body.appendChild(tempDiv);

                // Create a range and select the node
                const range = document.createRange();
                range.selectNodeContents(tempDiv);

                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                try {
                    document.execCommand('copy');
                    document.getElementById("copyMsg").style.display = "inline";
                    setTimeout(() => document.getElementById("copyMsg").style.display = "none", 3000);
                } catch (err) {
                    alert('Copy failed. Please select and copy manually.');
                }

                // Cleanup
                document.body.removeChild(tempDiv);
                selection.removeAllRanges();
            });
        }

        // Save signature handler (calls Supabase function)
        document.getElementById("saveBtn").addEventListener("click", async function () {
            console.log("Save button clicked");
            console.log("window.saveSignatureToSupabase available:", typeof window.saveSignatureToSupabase);
            
            if (!window.saveSignatureToSupabase) {
                console.error("saveSignatureToSupabase not available");
                alert("Supabase not loaded yet. Please wait a moment and try again.");
                return;
            }
            try {
                console.log("Calling saveSignatureToSupabase");
                await window.saveSignatureToSupabase();
                console.log("saveSignatureToSupabase completed");
            } catch (error) {
                console.error("Error saving signature:", error);
                alert("Error saving signature: " + error.message);
            }
        });
    </script>
    
    <!-- Supabase SDK - Required for auth.js to work -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Comprehensive diagnostic function
        function diagnoseJavaScriptIssues() {
            console.log("🔍 JAVASCRIPT DIAGNOSTIC REPORT 🔍");
            console.log("===============================");
            
            // Check if generateSignature is available
            console.log("1. generateSignature function:");
            console.log("   - typeof generateSignature:", typeof generateSignature);
            console.log("   - window.generateSignature:", typeof window.generateSignature);
            
            // Check DOM elements
            console.log("2. DOM Elements:");
            const elements = ['fullName', 'title', 'phone', 'emailUser'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`   - ${id}:`, element ? '✅ Found' : '❌ Missing');
            });
            
            // Check for syntax errors
            console.log("3. Script loading status:");
            console.log("   - Document ready state:", document.readyState);
            console.log("   - BrandCentralAuth:", !!window.BrandCentralAuth);
            console.log("   - Supabase:", !!window.supabase);
            
            console.log("===============================");
            
            // Test function call
            if (typeof window.generateSignature === 'function') {
                console.log("✅ generateSignature is available, testing call...");
                try {
                    window.generateSignature();
                    console.log("✅ generateSignature executed successfully");
                } catch (error) {
                    console.error("❌ Error calling generateSignature:", error);
                }
            } else {
                console.error("❌ generateSignature not available globally");
            }
        }
        
        // Run diagnostics when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', diagnoseJavaScriptIssues);
        } else {
            diagnoseJavaScriptIssues();
        }
        
        // Use the global Supabase client from BrandCentralAuth
        let supabase;
        let currentUser = null;
        
        // Wait for BrandCentralAuth to be available and use its Supabase client
        function initializeSupabase() {
            console.log("🔍 Checking for BrandCentralAuth...");
            console.log("- window.BrandCentralAuth exists:", !!window.BrandCentralAuth);
            if (window.BrandCentralAuth) {
                console.log("- BrandCentralAuth.isInitialized exists:", typeof window.BrandCentralAuth.isInitialized === 'function');
                console.log("- BrandCentralAuth.supabase exists:", !!window.BrandCentralAuth.supabase);
                if (typeof window.BrandCentralAuth.isInitialized === 'function' && window.BrandCentralAuth.isInitialized()) {
                    console.log("- BrandCentralAuth.isInitialized():", window.BrandCentralAuth.isInitialized());
                }
            }
            
            if (window.BrandCentralAuth && typeof window.BrandCentralAuth.isInitialized === 'function' && window.BrandCentralAuth.isInitialized()) {
                supabase = window.BrandCentralAuth.supabase;
                console.log("✅ Using global Supabase client from BrandCentralAuth");
                return true;
            }
            return false;
        }

        // Save signature to Supabase
        window.saveSignatureToSupabase = async function () {
            console.log("saveSignature called");
            
            // Initialize Supabase client if not already done
            if (!supabase && !initializeSupabase()) {
                console.log("⏳ Waiting for BrandCentralAuth...");
                setTimeout(() => window.saveSignatureToSupabase(), 500);
                return;
            }

            const name = document.getElementById("fullName").value;
            const title = document.getElementById("title").value;
            const phone = document.getElementById("phone").value;
            const emailUser = document.getElementById("emailUser").value;
            const headshot = window.headshotDataUrl || headshotDataUrl || "";

            console.log("Form data:", { name, title, phone, emailUser, hasHeadshot: !!headshot });

            if (!name && !title && !phone && !emailUser && !headshot) {
                alert("Please fill in at least one field before saving.");
                return;
            }

            try {
                console.log("💾 Saving signature to Supabase...");
                
                const { data, error } = await supabase
                    .from('email_signatures')
                    .insert([{
                        name: name || "",
                        title: title || "",
                        phone: phone || "",
                        email: emailUser || "",
                        headshot: headshot,
                        created_by: currentUser?.id || null,
                        created_at: new Date().toISOString()
                    }]);

                if (error) {
                    throw error;
                }

                console.log("✅ Signature saved successfully");
                document.getElementById("saveMsg").style.display = "inline";
                setTimeout(() => document.getElementById("saveMsg").style.display = "none", 2000);
                await displaySavedSignatures();
                
            } catch (e) {
                console.error("❌ Error saving signature:", e);
                
                if (e.message.includes('permission') || e.message.includes('policy')) {
                    alert("Permission denied. Please sign in to save signatures.");
                } else if (e.message.includes('network')) {
                    alert("Network error. Please check your internet connection and try again.");
                } else {
                    alert("Error saving signature: " + e.message);
                }
            }
        };

        // Display saved signatures
        async function displaySavedSignatures() {
            const container = document.getElementById("savedSignaturesContent");
            container.innerHTML = "";
            
            // Initialize Supabase client if not already done
            if (!supabase && !initializeSupabase()) {
                container.innerHTML += "<div style='color:#orange;'>⏳ Waiting for authentication...</div>";
                return;
            }
            
            try {
                console.log("📋 Loading saved signatures...");
                const { data: signatures, error } = await supabase
                    .from('email_signatures')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    throw error;
                }

                console.log("✅ Query completed. Found", signatures?.length || 0, "signatures");
                
                if (!signatures || signatures.length === 0) {
                    container.innerHTML += "<div style='color:#ccc;'>No saved signatures found.</div>";
                    return;
                }
                
                signatures.forEach((signature) => {
                    console.log("Signature data:", signature);
                    container.innerHTML += `
                        <div class="signature-card">
                            <div><strong>Name:</strong> ${signature.name || "Not specified"}</div>
                            <div><strong>Title:</strong> ${signature.title || "Not specified"}</div>
                            <div><strong>Phone:</strong> ${signature.phone || "Not specified"}</div>
                            <div><strong>Email Username:</strong> ${signature.email || "Not specified"}</div>
                            ${signature.headshot ? `<img src="${signature.headshot}" alt="Headshot">` : "<div style='color:#999;'>No headshot</div>"}
                            <div style="margin-top:8px;">
                                <button onclick="loadSignature('${signature.id}')" style="padding:4px 8px; background:#3FCBFF; color:#1F1633; border:none; border-radius:8px; cursor:pointer; margin-right:8px;">Load</button>
                                <button onclick="deleteSignature('${signature.id}')" style="padding:4px 8px; background:#ff6b6b; color:#fff; border:none; border-radius:8px; cursor:pointer;">Delete</button>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error("❌ Error loading saved signatures:", error);
                
                if (error.message.includes('permission') || error.message.includes('policy')) {
                    container.innerHTML += "<div style='color:#ff6b6b;'>Permission denied. Please sign in to view saved signatures.</div>";
                } else if (error.message.includes('network')) {
                    container.innerHTML += "<div style='color:#ff6b6b;'>Network error. Please check your internet connection.</div>";
                } else {
                    container.innerHTML += "<div style='color:#ff6b6b;'>Error loading saved signatures: " + error.message + "</div>";
                }
            }
        }

        // Expose for main script to call after save
        window.displaySavedSignatures = displaySavedSignatures;

        // Load a saved signature into the form
        window.loadSignature = async function(id) {
            console.log("📥 Loading signature with ID:", id);
            
            // Initialize Supabase client if not already done
            if (!supabase && !initializeSupabase()) {
                alert("⏳ Please wait for authentication to complete...");
                return;
            }
            
            try {
                const { data: signature, error } = await supabase
                    .from('email_signatures')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) {
                    throw error;
                }

                if (signature) {
                    console.log("✅ Loaded signature data:", signature);
                    
                    document.getElementById("fullName").value = signature.name || "";
                    document.getElementById("title").value = signature.title || "";
                    document.getElementById("phone").value = signature.phone || "";
                    document.getElementById("emailUser").value = signature.email || "";
                    
                    if (signature.headshot) {
                        headshotDataUrl = signature.headshot;
                        window.headshotDataUrl = signature.headshot;
                    } else {
                        headshotDataUrl = "";
                        window.headshotDataUrl = "";
                    }
                    
                    generateSignature();
                } else {
                    console.error("Signature not found!");
                    alert("Signature not found!");
                }
            } catch (error) {
                console.error("❌ Error loading signature:", error);
                alert("Error loading signature: " + error.message);
            }
        };

        // Delete signature function
        window.deleteSignature = async function(id) {
            // Initialize Supabase client if not already done
            if (!supabase && !initializeSupabase()) {
                alert("⏳ Please wait for authentication to complete...");
                return;
            }
            
            // Confirm deletion
            if (!confirm("Are you sure you want to delete this signature? This action cannot be undone.")) {
                return;
            }
            
            try {
                console.log("🗑️ Deleting signature with ID:", id);
                const { error } = await supabase
                    .from('email_signatures')
                    .delete()
                    .eq('id', id);

                if (error) {
                    throw error;
                }

                console.log("✅ Signature deleted successfully!");
                alert("Signature deleted successfully!");
                
                // Refresh the saved signatures display
                displaySavedSignatures();
            } catch (error) {
                console.error("❌ Error deleting signature:", error);
                
                if (error.message.includes('permission') || error.message.includes('policy')) {
                    alert("Permission denied. Please sign in to delete signatures.");
                } else if (error.message.includes('network')) {
                    alert("Network error. Please check your internet connection and try again.");
                } else {
                    alert("Error deleting signature: " + error.message);
                }
            }
        };

        // Add auth state listener and initial load
        async function initializeSignatureGenerator() {
            // Wait for BrandCentralAuth and get the global Supabase client
            if (initializeSupabase()) {
                console.log('✅ Using global Supabase client');
                
                // Get current user from BrandCentralAuth
                if (window.BrandCentralAuth && window.BrandCentralAuth.getCurrentUser) {
                    currentUser = window.BrandCentralAuth.getCurrentUser();
                    if (currentUser) {
                        console.log('👤 Current user from BrandCentralAuth:', currentUser.email);
                        displaySavedSignatures();
                    } else {
                        console.log('👤 No current user, waiting for sign in...');
                        // Set up a listener for when user signs in
                        const checkForUser = setInterval(() => {
                            const user = window.BrandCentralAuth.getCurrentUser();
                            if (user) {
                                currentUser = user;
                                console.log('👤 User signed in:', user.email);
                                displaySavedSignatures();
                                clearInterval(checkForUser);
                            }
                        }, 1000);
                    }
                }
            } else {
                console.log('⏳ Waiting for BrandCentralAuth to initialize...');
                setTimeout(initializeSignatureGenerator, 1000);
            }
        }

        // Initialize when page loads - give more time for auth.js to load
        setTimeout(initializeSignatureGenerator, 2000);
    </script>

    <!-- Authentication helper -->
    <script src="auth.js"></script>

    <script>
        // Initialize page with auth check
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 Email Signature Generator page loaded');
            
            // Simple check - the main initialization happens in initializeSignatureGenerator()
            function checkAuthReady() {
                if (window.BrandCentralAuth && typeof window.BrandCentralAuth.isInitialized === 'function' && window.BrandCentralAuth.isInitialized()) {
                    console.log('✅ BrandCentralAuth ready');
                } else {
                    console.log('⏳ Waiting for BrandCentralAuth to initialize...');
                    setTimeout(checkAuthReady, 1000);
                }
            }
            
            checkAuthReady();
        });
    </script>
</body>
</html>
